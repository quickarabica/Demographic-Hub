<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demographic Data Management - Manual Entry</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="bg-slate-50 min-h-screen text-slate-900">
    <div id="statusBar" class="fixed top-4 right-4 z-50 hidden"></div>
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6 space-y-6">
      <header
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
      >
        <div>
          <p class="text-sm uppercase tracking-wide text-slate-500">
            Data Entry
          </p>
          <h1 class="text-3xl font-bold text-slate-900">
            Manual Record Capture
          </h1>
          <p class="text-slate-500">Add voter(s) record with validation.</p>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <section
          class="bg-white border-2 border-slate-300 rounded-2xl p-6 shadow-lg"
        >
          <h2 class="text-xl font-semibold mb-4">Single Entry</h2>
          <form id="manualForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="field">
              <span class="field-label">Full name</span>
              <input
                type="text"
                id="name"
                class="input"
                placeholder="e.g. Riya Sharma"
                required
              />
            </label>
            <label class="field">
              <span class="field-label">Age</span>
              <input
                type="number"
                id="age"
                class="input"
                placeholder="28"
                required
              />
            </label>
            <label class="field">
              <span class="field-label">Sex</span>
              <select id="sex" class="input" required>
                <option value="">Select sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </label>
            <label class="field">
              <span class="field-label">Address</span>
              <input
                type="text"
                id="address"
                class="input"
                placeholder="Street, City"
                required
              />
            </label>
            <label class="field">
              <span class="field-label">Part No</span>
              <input
                type="text"
                id="part_no"
                class="input"
                placeholder="123"
                required
              />
            </label>
            <label class="field">
              <span class="field-label">Society</span>
              <input
                type="text"
                id="society"
                class="input"
                placeholder="Housing society"
                required
              />
            </label>
            <label class="field">
              <span class="field-label">Caste</span>
              <input
                type="text"
                id="caste"
                class="input"
                placeholder="Caste"
                required
              />
            </label>
            <button type="submit" class="btn-primary w-full col-span-2">
              Add Record
            </button>
          </form>
        </section>

        <section
          class="bg-white border-2 border-slate-300 rounded-2xl p-6 shadow-lg"
        >
          <h2 class="text-xl font-semibold mb-4">Bulk Upload (CSV)</h2>
          <div class="space-y-3">
            <input type="file" id="fileInput" accept=".csv" class="input" />
            <p class="text-sm text-slate-400">
              CSV columns: name, age, sex, address, part_no, society, caste
            </p>
            <p class="text-xs text-slate-500">
              Tip: Clean your CSV headers to match exactly. Bulk upload replaces
              nothing; it appends records.
            </p>
          </div>
        </section>
      </div>
    </div>
    <script src="navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      const API_BASE =
        window.location.hostname === "localhost"
          ? "http://localhost:3000"
          : "https://demographic-hub-10.onrender.com";

      const showStatus = (message, type = "success") => {
        const bar = document.getElementById("statusBar");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        bar.appendChild(toast);
        bar.classList.remove("hidden");
        setTimeout(() => {
          toast.remove();
          if (!bar.hasChildNodes()) bar.classList.add("hidden");
        }, 3200);
      };

      renderNavbar("manual");
      document
        .getElementById("manualForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            name: document.getElementById("name").value,
            age: document.getElementById("age").value,
            sex: document.getElementById("sex").value,
            address: document.getElementById("address").value,
            part_no: document.getElementById("part_no").value,
            society: document.getElementById("society").value,
            caste: document.getElementById("caste").value,
          };
          try {
            await axios.post(`${API_BASE}/api/records`, formData);
            document.getElementById("manualForm").reset();
            showStatus("Record added successfully!", "success");
          } catch (error) {
            console.error("Error adding record:", error);
            showStatus("Failed to add record", "error");
          }
        });
      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          Papa.parse(file, {
            header: true,
            complete: async (result) => {
              const data = result.data.map((row) => ({
                name: row.name || "",
                age: row.age || "",
                sex: row.sex || "",
                address: row.address || "",
                part_no: row.part_no || "",
                society: row.society || "",
                caste: row.caste || "",
              }));
              try {
                await axios.post(`${API_BASE}/api/records/bulk`, data);
                e.target.value = "";
                showStatus("Records uploaded successfully!", "success");
              } catch (error) {
                console.error("Error uploading bulk data:", error);
                showStatus("Failed to upload records", "error");
              }
            },
          });
        }
      });
    </script>
  </body>
</html>
